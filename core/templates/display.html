<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml">
<html>
    <head>
        <title>Touchscreen</title>
            
        <style>
            {% include "display.css" %}
        </style>

        <!-- jQuery includes -->
        <script type='text/javascript' src="{{MEDIA_URL}}/js/jquery-1.3.2.min.js"></script>
        <script type='text/javascript' src="{{MEDIA_URL}}/js/jquery.doubleBorderedBox.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.refreshimage.js"></script>
		<script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.scale/jquery.scale.js"></script>	
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.cycle.all.js"></script>   
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.marquee.js"></script>     
        
         <!-- jQuery UI includes -->
        <link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}/js/jquery.ui/theme/ui.all.css" />
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.ui/jquery.ui.core-1.7.2.js"></script>
		<script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.ui/jquery.ui.draggable-1.7.2.js"></script>

        <!-- other includes -->
        <script type="text/javascript" src="{{MEDIA_URL}}/js/util.js"></script>
        
		<script type="text/javascript">

            /* ===============================
             *  Shower / Hiders
             * =============================== */
            function slide_in(screen) {
                id = screen['id']
                duration = 1000;
                $('#screen_'+id).animate({left:0}, duration );
                return duration;
            }

            function slide_out(screen) {
                id = screen['id']
                duration = 1000;
                $('#screen_'+id).animate({left:-1400}, duration );
                return duration;
            }

            function fade_in(screen) {
                id = screen['id']
                $screen = $('#screen_'+id);

                //first move the screen into place
                $screen.css('left',0);

                //animate fading in of background
                $screen.children('.background').fadeIn(500, function(){
                    $screen.children('.content').fadeIn(750);
                });
                return 1250
            }

            function fade_out(screen) {
                id = screen['id']
                $screen = $('#screen_'+id);

                //fade the contents out
                $screen.children('.content').fadeOut(750, function(){
                    //fade the background out
                    $screen.children('.background').fadeOut(750, function(){
                        //move the box off the screen 
                        $screen.css('left',-1400);
                    });
                });

                return 1500;
            }

            /* ===============================
             *  Show / Hide Screen
             * =============================== */
            // index of screen currently displayed, or in process of being displayed
            var current_screen_index = -1
            var show_timer = 0;
            var start_timer = 0;
            var winResizeEventPointer = null; // for saving/restoring the win.resize pointer

            function show_slide(screen) {
                if (slideshow_screen_index != current_screen_index) {
                    // hide slide if one is shown
                    if (current_screen_index != -1){
                        current_screen = screens[current_screen_index];
                        safelog('hiding: ' + current_screen['id']);
                        hider = eval(hiders[current_screen['hide']]);
                        var hidetime = hider(current_screen);

                        //restore the window.resize event pointer to what it was
                        //before the screen was shown and hide the screen
                        window.onresize = winResizeEventPointer;
                        safelog( "core: window.resize pointer restored to " + window.resize );
                        eval(current_screen['stop']);
                        
                    } else {
                        // no current slide
                        var hidetime = 0;
                    }

                    current_screen_index = slideshow_screen_index;

                    if(!hidetime) {
                        hidetime = 999
                    }

                    //clear past timer in case next/prev was clicked repeatedly
                    if (show_timer) { clearTimeout(show_timer)};
                    if (start_timer) { clearTimeout(start_timer)};

                    //save the window.resize event pointer and call onWinResize
                    //event for the current screen
                    winResizeEventPointer = window.onresize;
                    window.onresize = function(){ 
                        eval(screens[current_screen_index]['onWinResize']);
                    }         
                    safelog( "core: window.resize changed from " + winResizeEventPointer + " to " + window.onresize );
                    
                    show = showers[screen['show']];
                    safelog('core: showing ' + screen['id']);
                    show_timer = setTimeout( "show_slide_animation_wrapper('"+show+"(screens[current_screen_index])',"+ current_screen_index +")", hidetime);
                }
            }

            /*
            function that wraps the animation call for showing the next screen.
            This is used to delay calling screen.start() until after the screen
            has been shown
            */
            function show_slide_animation_wrapper (func, screen_index) {
                start_timer = showtime = eval(func);
                setTimeout(screens[screen_index]['start']);
            }

            /* ===============================
             *  SLIDE SHOW
             * =============================== */
            // tracks timer for automatic slideshow, used for pausing slideshow
            var slide_show_timer = -1;

            // tracks slideshow index, may temporarily hold next or previous screen
            var slideshow_screen_index = -1;

            // initializes and starts slideshow from the first slide
            function slide_show_start() {
                slide_show_loop();
            }
            
            // loops slides automatically
            function slide_show_loop() {
                var screen = slide_show_next();

                //set next transition to duration of current slide
                safelog('core: next screen in ' + 
                    parseInt(screen['duration'])/1000 + " seconds");
                slide_show_timer = setTimeout(slide_show_loop, screen['duration']);
            }

            // pauses the slideshow
            function slide_show_stop() {
                if (slide_show_timer) {
                    clearTimeout(slide_show_timer);
                    slide_show_timer = -1;
                }
            }

            // advances to the next slide 
            function slide_show_next() {
                //get next slide
                var screen = get_next_slide();
                while (!screen['slideshow']) {
                    screen = get_next_slide();
                }

                show_slide(screen);
                return screen;
            }

            // advances to the previous slide
            function slide_show_prev() {
                //get next slide
                var screen = get_prev_slide();
                while (!screen['slideshow']) {
                    screen = get_prev_slide();
                }

                show_slide(screen);
            }

            // gets next potential screen to be displayed
            function get_next_slide() {
                if (slideshow_screen_index+1 == screens.length) {
                    slideshow_screen_index = 0;
                } else {
                    slideshow_screen_index = slideshow_screen_index + 1;
                }
                return screens[slideshow_screen_index];
            }

            // gets prev potential screen to be displayed
            function get_prev_slide() {
                if (slideshow_screen_index) {
                    slideshow_screen_index = slideshow_screen_index-1 ;
                } else {
                    slideshow_screen_index = screens.length-1;
                }
                return screens[slideshow_screen_index];
            }

             /* ===============================
             *  Slide Show Remote Commands
             * =============================== */
            function remote_slide_show_prev(){
                slide_show_prev();
            }

            function remote_slide_show_stop(){
                //do nothing its already stopped;
            }

            function remote_slide_show_play(){
                slide_show_start();
            }

            function remote_slide_show_next() {
                slide_show_next();
            }


            /* ===============================
             *  AJAX Messaging
             * =============================== */
            function Messaging_start() {

            }

            /* ===============================
             *  Initialization
             * =============================== */

            // setup screen datastructures
            var screens = new Array()
            {% for key, screen in screens.items %}
                screens[{{forloop.counter0}}] =
                    {
                        'id':       '{{key}}',              // Screen identifier (name)
                        'hide':     '{{screen.hide}}',      // Function for hiding the screen
                        'show':     '{{screen.show}}',      // Function for showing the screen
                        'duration': {{screen.duration}},    // How long screen will be displayed
                        'slideshow':{% if screen.slideshow %}1{%else%}0{%endif%},   // Include in slideshow
                        'init':     '{{screen.js_init}}',   // Javascript function called when screen is first loaded
                        'start':    '{{screen.js_start}}',  // Javascript function called after showing the screen
                        'stop':     '{{screen.js_stop}}',   // Javascript function called after hiding the screen
                        'onWinResize': '{{screen.js_onWinResize}}' // Javascript function called when window is resized
                    }
            {% endfor %}

            // setup show/hide animations
            hiders  = {
                        'slide':'slide_out',
                        'fade':'fade_out'
                      };
            showers = {
                        'slide':'slide_in',
                        'fade':'fade_in'
                      };

            // global functions for querying the size of the viewport
            function screenHeight(){ return Screen.getViewportHeight(); }
            function screenWidth(){ return Screen.getViewportWidth(); }

            // hides all screens
            function hide_all() {
                for (i=0; i<screens.length; i++) {
                    //get hider and call it for the screen
                    hider_key = screens[i]['hide'];
                    hider = hiders[hider_key];
                    eval(hider+'(screens[i])');
                    safelog("core: Hiding " + screens[i]['id']);
                }
                safelog("core: All screens hidden");
            }

            // inits all screens
            function init_all() {

                // check for the existance of event functions in the screens,
                // void them if they don't exist, and validate if they do           
                for (i=0; i<screens.length; i++) {
                    if( screens[i]['start'] == "None" )
                        screens[i]['start'] = void(0);
                    else
                        screens[i]['start'] += '()';
                        
                    if( screens[i]['stop'] == "None" )
                        screens[i]['stop'] = void(0);
                    else
                        screens[i]['stop'] += '()';
                        
                    if( screens[i]['onWinResize'] == "None" )
                        screens[i]['onWinResize'] = void(0);
                    else
                        screens[i]['onWinResize'] += '()';

                    if( screens[i]['init'] == "None" )
                        screens[i]['init'] = void(0);
                    else{
                        screens[i]['init'] += '()';
                        eval(screens[i]['init']);
                    }
                }

                safelog("core: All screens initialized");
            }

            // on load handler.
            $(document).ready(function() {
                safelog("core: Initializing Display");
                hide_all();
                init_all();
                slide_show_start();
                Messaging_start();

                //SLIDESHOW BUTTONS FOR DEBUGGING
                $('.debug_buttons').hover(
                    function(){$(this).addClass("ui-state-hover");},
                    function(){$(this).removeClass("ui-state-hover");}
                );
                $('#debug_play').click(function(){ 
                    safelog("debug menu: playing slideshow");
                    slide_show_stop();
                    remote_slide_show_play();
                });                
                $('#debug_stop').click(function(){
                    safelog("debug menu: stopping slideshow");
                    slide_show_stop();
                    remote_slide_show_stop();
                });
                $('#debug_refresh').click(function(){
                    safelog("debug menu: refreshing current slide");
                    remote_slide_show_next();
                    remote_slide_show_prev();
                });
                $('#debug_next').click(function(){
                    safelog("debug menu: going to next slide");
                    slide_show_stop();
                    remote_slide_show_next();
                });
                $('#debug_prev').click(function(){
                    safelog("debug menu: going to previous slide");
                    slide_show_stop();
                    remote_slide_show_prev();
                });
                
                $('#debug_close').click(function(){
                    safelog("debug menu: debug menu hiding");
                    $("#debug_window").slideToggle("slow");
                });
            
                //make debug window draggable
                $('#debug_window').draggable();

            });

        </script>
    </head>

    <body>

        <div id='screens'>
        
            <!-- debug window -->
            <table id='debug_window' class='ui-widget ui-corner-all'>
                <tr>
                    <td colspan="4" class="debug_button-cells">
                        <b>debug</b>
                    </td>
                    <td class="debug_button-cells">
                        <span id="debug_close" class="debug_buttons ui-icon ui-icon-close"></span>
                    </td>
                </tr>
                <tr>
                    <td class="debug_button-cells">
                        <span id="debug_play" class="debug_buttons ui-icon ui-icon-play"></span></td>
                    <td class="debug_button-cells">
                        <span id="debug_stop" class="debug_buttons ui-icon ui-icon-stop"></span></td>
                    <td class="debug_button-cells">
                        <span id="debug_refresh" class="debug_buttons ui-icon ui-icon-refresh"></span></td>
                    <td class="debug_button-cells">
                        <span id="debug_prev" class="debug_buttons ui-icon ui-icon-seek-prev"></span></td>
                    <td class="debug_button-cells">
                        <span id="debug_next" class="debug_buttons ui-icon ui-icon-seek-next"></span></td>
                </tr>
            </table>
        
            <!-- create screen divs -->
            {% for key, screen in screens.items %}
                <div id='screen_{{screen.hash}}' class='screen'>
                    {% include screen.template %}
                </div>
            {% endfor %}
            
        </div>
    </body> 
