<!--
    screen_sponsors.html
    by Rob McGuire-Dale, 9/3/2009

    This screen displays a list of sponsors and friends.
-->

<style>
    /* debug colors for scrollers
    .cloned{ color:red; }
    .active{ color:yellow; } */

    .screen_sponsors_sponsor{
        margin-bottom: 1.5em;
    }
</style>

<script type="text/javascript">

    /////////////////
    // Global Data //
    /////////////////

    // a simple friends list
    var screen_sponsors_friends_data = new Array();

    // a list of sponsor records
    var screen_sponsors_sponsors_data = new Array();

    // a sponsors records class
    function screen_sponsors_sponsors_record( title, bodyParagraphs ){
        this.title = title; this.body = bodyParagraphs }

    // scroller plugin APIs for the friends and sponsors tiles
    var screen_sponsors_friends_scroller = null;
    var screen_sponsors_sponsors_scroller = null;

    // autoscroll timers
    var screen_sponsors_friends_autoScrollTimer = null;
    var screen_sponsors_sponsors_autoScrollTimer = null;

    ///////////////////
    // Screen Events //
    ///////////////////

    function screen_sponsors_init()
    {
        safelog('screen_sponsors: initializing...');

        // initialize the scroller plugin for the tiles
        screen_sponsors_friends_scroller =
            $( ".screen_sponsors_friends" ).scrollable({
                vertical:true,
                items:".display_scrollable_items",
                speed:{{settings.screen_sponsors_screen_sponsors.friends_scroll_speed}},
                api:true,
            });
        screen_sponsors_sponsors_scroller =
            $( ".screen_sponsors_sponsors" ).scrollable({
                vertical:true,
                items:".display_scrollable_items",
                speed:{{settings.screen_sponsors_screen_sponsors.sponsors_scroll_speed}},
                api:true,
            });

        // load friends and sponsors data
        screen_sponsors_loadData();
    }

    function screen_sponsors_start()
    {
        safelog('screen_sponsors: starting...');

        screen_sponsors_refreshTiles();

        // start auto scrolling
        screen_sponsors_friends_startAutoAdvance();
        screen_sponsors_sponsors_startAutoAdvance();
    }

    function screen_sponsors_stop()
    {
        safelog('screen_sponsors: stopping');

        // stop autoscrolling
        clearTimeout(screen_sponsors_friends_autoScrollTimer);
        clearTimeout(screen_sponsors_sponsors_autoScrollTimer);
    }

    function screen_sponsors_onScreenResize()
    {
        safelog('screen_sponsors: window resized to ' + screenWidth() + "x" +
            screenHeight());

        screen_sponsors_refreshTiles();
    }

    //////////////////////
    // Auto Advancement //
    //////////////////////

    function screen_sponsors_friends_startAutoAdvance()
    {
        // grab the scroll interval value
        var interval =
            {{settings.screen_sponsors_screen_sponsors.friends_scroll_interval}};

        // Ensure the interval is at least 50 ms > than the advancement speed
        if( {{settings.screen_sponsors_screen_sponsors.friends_scroll_speed}} >
            interval - 50 )

            interval =
                {{settings.screen_sponsors_screen_sponsors.friends_scroll_speed}}
                + 50;


        // Make sure scolling starts in the middle of the list
        if( screen_sponsors_friends_scroller.getClickIndex() == -1 )
            screen_sponsors_friends_scroller.click(
                screen_sponsors_friends_scroller.getConf().size/2 );

        // Otherwise, advance to the next friend. Tuned to work with circular
        // plugin.
        else
            screen_sponsors_friends_scroller.click(
                screen_sponsors_friends_scroller.getClickIndex() -
                 screen_sponsors_friends_scroller.getConf().size + 1 );

        screen_sponsors_friends_autoScrollTimer =
            setTimeout('screen_sponsors_friends_startAutoAdvance()', interval );
    }

    function screen_sponsors_sponsors_startAutoAdvance()
    {
        // grab the scroll interval value
        var interval =
            {{settings.screen_sponsors_screen_sponsors.sponsors_scroll_interval}};

        // Ensure the interval is at least 50 ms > than the advancement speed
        if( {{settings.screen_sponsors_screen_sponsors.sponsors_scroll_speed}} >
            interval - 50 )

            interval =
                {{settings.screen_sponsors_screen_sponsors.sponsors_scroll_speed}}
                + 50;


        // Make sure scolling starts in the middle of the list
        if( screen_sponsors_sponsors_scroller.getClickIndex() == -1 )
            screen_sponsors_sponsors_scroller.click(
                screen_sponsors_sponsors_scroller.getConf().size/2 );

        // Otherwise, advance to the next friend. Tuned to work with circular
        // plugin.
        else
            screen_sponsors_sponsors_scroller.click(
                screen_sponsors_sponsors_scroller.getClickIndex() -
                 screen_sponsors_sponsors_scroller.getConf().size + 1 );

        screen_sponsors_sponsors_autoScrollTimer =
            setTimeout('screen_sponsors_sponsors_startAutoAdvance()', interval );
    }

    //////////////////
    // Tile Refresh //
    //////////////////

    function screen_sponsors_refreshTiles()
    {
        safelog( "screen_sponsors: refreshing tiles." );

        // reposition the tiles
        screen_sponsors_positionTiles();

        // if the data is loaded, fill the tiles
        var dataLoaded = screen_sponsors_sponsors_data.length > 0 &&
            screen_sponsors_friends_data.length > 0;

        if( dataLoaded ){
            screen_sponsors_updateFriendsTile();
            screen_sponsors_updateSponsorsTile();
        } else
            safelog( "screen_sponsors: tiles NOT refreshed because data " +
                "isn't loaded yet." );
    }

    function screen_sponsors_updateFriendsTile()
    {
        var curHeight = 0;   // to hold the height of the current item
        var totalHeight = 0; // total height of the items written
        var itemCount = 0;   // number of items written

        // grab the height of the container tile
        var tileHeight = $(".screen_sponsors_friends").height();
        safelog( "screen_sponsors: tile height: " + tileHeight );

        // clear the friends list
        screen_sponsors_friends_scroller.getItems().remove();

        // Fill up the tile with items, wrapping if necessary
        while( totalHeight < tileHeight ){

            //safelog( "screen_sponsors: writing friend # " + itemCount );

            // Add the next item, wrapping to the first if necessary
            screen_sponsors_friends_scroller.getItemWrap().append(
                "<p class='screen_sponsors_friend_"+itemCount+"'>" +
                screen_sponsors_friends_data[
                    itemCount % screen_sponsors_friends_data.length ] +
                "</p>"
            );

            // the *actual* height each item takes up, as positioned by the
            // scollable plugin (as observed by firebug)
            curHeight =
                $(".screen_sponsors_friend_" + itemCount ).innerHeight() +
                ($(".screen_sponsors_friend_" + itemCount ).outerHeight(true)-
                $(".screen_sponsors_friend_" + itemCount ).innerHeight())/2;
            //safelog( "screen_sponsors: current itemheight: " + curHeight );

            // add to the running height total
            totalHeight += curHeight;
            //safelog( "screen_sponsors: current total height: " + totalHeight );

            // increment the number of items in the written list
            itemCount++;
        }
        safelog( "screen_sponsors: total friends height: " + totalHeight );

        // update the scroller to include the new items
        screen_sponsors_friends_scroller.reload();

        // set new tile page size for the scroller
        screen_sponsors_friends_scroller.getConf().size = itemCount;
        safelog( "screen_sponsors: Friends written: "+ itemCount );

        // make the scroller circular
        $( ".screen_sponsors_friends" ).circular();
    }

    function screen_sponsors_updateSponsorsTile()
    {
        var curHeight = 0;   // to hold the height of the current item
        var totalHeight = 0; // total height of the items written
        var itemCount = 0;   // number of items written

        // grab the size of the data
        var dataLength = screen_sponsors_sponsors_data.length;

        // grab the height of the container tile
        var tileHeight = $(".screen_sponsors_sponsors").height();
        safelog( "screen_sponsors: sponsors tile height: " + tileHeight );

        // clear the sponsors list
        screen_sponsors_sponsors_scroller.getItems().remove();

        // Fill up the tile with items, wrapping if necessary
        while( totalHeight < tileHeight ){

            //safelog( "screen_sponsors: writing sponsor # " + itemCount );

            // Add the next title, wrapping to the first if necessary
            screen_sponsors_sponsors_scroller.getItemWrap().append(
                "<div class='screen_sponsors_sponsor screen_sponsors_sponsor_" +
                itemCount+"'><h1>" + screen_sponsors_sponsors_data[
                    itemCount % dataLength ].title +
                "</h1></div>"
            );

            // Add the next bodies, wrapping to the first if necessary
            for( var i = 0; i < (screen_sponsors_sponsors_data[itemCount%dataLength].body.length); i++ ){
                $(".screen_sponsors_sponsor_"+itemCount).append(
                    "<p>" +
                    screen_sponsors_sponsors_data[itemCount%dataLength].body[i] +
                    "</p>"
                );
            }

            // the *actual* height each item takes up, as positioned by the
            // scollable plugin (as observed by firebug)
            curHeight =
                $(".screen_sponsors_sponsor_" + itemCount ).innerHeight() +
                ($(".screen_sponsors_sponsor_" + itemCount ).outerHeight(true)-
                $(".screen_sponsors_sponsor_" + itemCount ).innerHeight())/2;
            //safelog( "screen_sponsors: current sponsor height: " + curHeight );

            // add to the running height total
            totalHeight += curHeight;
            //safelog( "screen_sponsors: current sponsors total height: " + totalHeight );

            // increment the number of items in the written list
            itemCount++;
        }
        safelog( "screen_sponsors: total sponsors height: " + totalHeight );

        // update the scroller to include the new items
        screen_sponsors_sponsors_scroller.reload();

        // set new tile page size for the scroller
        screen_sponsors_sponsors_scroller.getConf().size = itemCount;
        safelog( "screen_sponsors: Sponsors written: "+ itemCount );

        // make the scroller circular
        $( ".screen_sponsors_sponsors" ).circular();
    }

    //////////////////////
    // Tile Positioning //
    //////////////////////

    function screen_sponsors_positionTiles()
    {
        // set the width of the bottom tiles per the settings
        $('.screen_sponsors_sponsors').width(
            {{settings.screen_sponsors_screen_sponsors.sponsors_max_width}});
        $('.screen_sponsors_friends').width(
            {{settings.screen_sponsors_screen_sponsors.friends_width}});

        // if the total tile width is too large to fit in the window,
        // resize the sponsors tile dynamically
        if( $('.screen_sponsors_friends').outerWidth( true ) +
            $('.screen_sponsors_sponsors').outerWidth( true ) >
            screenWidth() ){

            $('.screen_sponsors_sponsors').width( screenWidth() -
                $('.screen_sponsors_friends').outerWidth( true ) -
                ( $('.screen_sponsors_sponsors').outerWidth( true ) -
                $('.screen_sponsors_sponsors').width() ) );
        }

        // position the bottom tiles
        $('.screen_sponsors_friends').css('top',
            $('.screen_sponsors_title').outerHeight( true ) );
        $('.screen_sponsors_friends').css('left', 0 );
        $('.screen_sponsors_sponsors').css('top',
            $('.screen_sponsors_title').outerHeight( true ) );
        $('.screen_sponsors_sponsors').css('left',
            $('.screen_sponsors_friends').outerWidth( true ) );

        // set the height of the bottom tiles
        $('.screen_sponsors_sponsors').height( screenHeight() -
            $('.screen_sponsors_title').outerHeight(true) -
            $('.screen_sponsors_sponsors').outerHeight(true) +
            $('.screen_sponsors_sponsors').height());
        $('.screen_sponsors_friends').height( screenHeight() -
            $('.screen_sponsors_title').outerHeight(true) -
            $('.screen_sponsors_friends').outerHeight(true) +
            $('.screen_sponsors_friends').height());

        // size the title width to match the width of the bottom tiles
        $('.screen_sponsors_title').width(
            $('.screen_sponsors_friends').outerWidth( true ) +
            $('.screen_sponsors_sponsors').outerWidth( true ) -
            ( $('.screen_sponsors_title').outerWidth( true ) -
            $('.screen_sponsors_title').width() ) );

        // center the tiles
        $('.screen_sponsors_title').css( 'left', screenWidth()/2 -
            $('.screen_sponsors_title').outerWidth( true )/2 );
        $('.screen_sponsors_friends').css( 'left',
            parseInt( $('.screen_sponsors_title').css( 'left' ) ) );
        $('.screen_sponsors_sponsors').css( 'left',
            parseInt( $('.screen_sponsors_title').css( 'left' ) ) +
            $('.screen_sponsors_friends').outerWidth( true ) );

        // position and size gradient overlays
        $('#screen_sponsors_sponsors_gradient').css( 'z-index', 1 );
        $('#screen_sponsors_sponsors_gradient').css( 'top',
            -( $('#screen_sponsors_sponsors_gradient').outerHeight( true ) -
            $('#screen_sponsors_sponsors_gradient').height() ) );
        $('#screen_sponsors_sponsors_gradient').css( 'left',
            -( $('#screen_sponsors_sponsors_gradient').outerWidth( true ) -
            $('#screen_sponsors_sponsors_gradient').width() ) );
        $('#screen_sponsors_sponsors_gradient').height(
            $('.screen_sponsors_sponsors').outerHeight( ) );
        $('#screen_sponsors_sponsors_gradient').width(
            $('.screen_sponsors_sponsors').outerWidth( ) );

        $('#screen_sponsors_friends_gradient').css( 'z-index', 1 );
        $('#screen_sponsors_friends_gradient').css( 'top',
            -( $('#screen_sponsors_friends_gradient').outerHeight( true ) -
            $('#screen_sponsors_friends_gradient').height() ) );
        $('#screen_sponsors_friends_gradient').css( 'left',
            -( $('#screen_sponsors_friends_gradient').outerWidth( true ) -
            $('#screen_sponsors_friends_gradient').width() ) );
        $('#screen_sponsors_friends_gradient').height(
            $('.screen_sponsors_friends').outerHeight( ) );
        $('#screen_sponsors_friends_gradient').width(
            $('.screen_sponsors_friends').outerWidth( ) );
    }

    //////////////////
    // Data Loading //
    //////////////////

    function screen_sponsors_loadData()
    {
        // load friends TEST data
        screen_sponsors_friends_data.push(
            "Charles Montgomery Burns 0123456798",
            "Gladys Bouvier",
            "Carl Carlson",
            "Maude Flanders",
            "Professor John Frink",
            "Santa's Little Helper",
            "Kent Brockman",
            "Fat Tony",
            "Apu Nahasapeemapetilon",
            "Arnie Pye"
        );

        $.get('/proxy/?url={{settings.screen_sponsors_screen_sponsors.sponsors_URL}}', function( sponsors_XML ){
            
            // force a refresh the tiles after the data is loaded
            screen_sponsors_refreshTiles();
        });

        // grab and load sponsors XML file through a simple proxy to circumvent
        // browser security model restrictions regarding AJAX GET requests to
        // remote servers
        $.get('/proxy/?url={{settings.screen_sponsors_screen_sponsors.sponsors_URL}}', function( sponsors_XML ){

            // RegEx object representing the body and it's <p></p> delimiters
            var bodyPattern = /\<\s*p\s*\>.*<\s*\/\s*p\s*\>/g;

            // RegEx opject representing anchor tags
            var anchorOpen = /<\s*a.*?>/g;
            var anchorClose = /<\s*\/\s*a\s*>/g;

            // temporary title and body storage
            var parsedTitle = null;
            var parsedBody = null;

            // for each item...
            $(sponsors_XML).find("item").each( function( curItemIndex ){

                // load the title
                parsedTitle = $(this).find("title").text();
                safelog( "screen_sponsors: loading sponsor title: " +
                    parsedTitle );

                // load the body
                parsedBody =
                    $(this).find("description").text()
                    .replace(anchorOpen, "") // strip opening anchor tags
                    .replace(anchorClose, "")
                    .match(bodyPattern);

                safelog( "screen_sponsors: loading sponsor body: " +
                    parsedBody );

                // push a new record with the loaded data
                screen_sponsors_sponsors_data.push(
                    new screen_sponsors_sponsors_record( parsedTitle, parsedBody ) );
            });

            // force a refresh the tiles after the data is loaded
            screen_sponsors_refreshTiles();
        });
    }
</script>

<div class="display_tile display_title screen_sponsors_title">
    Sponsors
</div>

<div class="screen_sponsors_friends display_tile display_content">
    <img id='screen_sponsors_friends_gradient'
         class='display_gradient'
         src="{{SITE_ROOT}}/static/screen_sponsors/gradient.png">
    <div class='display_scrollable_items'>
        <!-- to be filled by refresh code above -->
    </div>
</div>

<div class="screen_sponsors_sponsors display_tile display_content">
    <img id='screen_sponsors_sponsors_gradient'
         class='display_gradient'
         src="{{SITE_ROOT}}/static/screen_sponsors/gradient.png">
    <div class='display_scrollable_items'>
        <!-- to be filled by refresh code above -->
    </div>
</div>
