<!--
    screen_weather.html
    by Rob McGuire-Dale, 12/31/2009

    This screen displays the current weather, and a 5-day forcast
-->

<script type="text/javascript">

    /////////////////
    // Global Data //
    /////////////////

    // unit information
    var screen_weather_units = {
        temp:null,      // i.e. F (fahrenheit) or C (celcius)
        distance:null,  // i.e. km or mi
        speed:null,     // i.e. kmh or mph
        pressure:null   // i.e. mb (millibars) or in (inches of mercury)
    };

    // location information
    var screen_weather_locationInfo = {
        name:null,      // city's name
        time:null,      // location's current time
        sunrise:null,   // time of sunrise
        sunset:null     // time of sunset
    };
    
    // current condition information
    var screen_weather_cc = {
        lastUpdate:null,        // when the information was last updated
        temp:null,              // the current temperature
        feelsLike:null,         // the "feels like" temperature
        condition:null,         // i.e. "sunny" or "overcast"
        icon:null,              // associated condition icon
        pressure:{              // barometric pressure
            value:null,         // pressure value
            description:null    // i.e. "steady"
        },
        wind:{                  // wind information
            speed:null,         // wind speed
            from:null           // direction wind is coming from, i.e. "NW"
        },
        humidity:null,          // the humidity percentage
        visual:null,            // visibility value (how far one can see)
        dewpoint:null,          // dewpoint temperature
        moon:{                  // moon information
            icon:null,          // associated moon phase icon
            description:null    // i.e. "full"
        },
    };

    // 5-day forecast information
    var screen_weather_forecast = {
        lastUpdate:null,    // when the forecast information was last updated
        days:new Array()    // an array of forecast days
    };
    
    // A single forecast day
    function screen_weather_forecast_day( 
        high,       // high temp of the day
        low,        // low temp of the day
        sunrise,    // sunrise time
        sunset,     // sunset time
        icon,       // icon associated with condition
        condition,  // condition description
        wind_speed, // speed of the wind
        wind_from,  // direction wind is coming from, i.e. "NW"
        precip,     // percent chance of precipitation
        humidity )  // humidity percentage
    {
        this.high = high;
        this.low = low;
        this.sunrise = sunrise;
        this.sunset = sunset;
        this.icon = icon;
        this.condition = condition;
        this.wind = {
            speed:wind_speed,
            from:wind_from
        };
        this.precip = precip;
        this.humidity = humidity;
    }

    ///////////////////
    // Screen Events //
    ///////////////////

    function screen_weather_init()
    {
        safelog('screen_weather: initializing...');
        
        screen_weather_forecast.days.push( 
            new screen_weather_forecast_day( null, null, null, null, null, null, 
                15, "NW", null, null ) );
                
        //alert( screen_weather_forecast.days[0].wind.speed );
    }

    function screen_weather_start()
    {
        safelog('screen_weather: starting...');
        
        screen_weather_loadData();
    }

    function screen_weather_stop()
    {
        safelog('screen_weather: stopping');
    }

    function screen_weather_onScreenResize()
    {
        safelog('screen_weather: window resized to ' + screenWidth() + "x" +
            screenHeight());
    }
    
    //////////////////
    // Facilitators //
    //////////////////
    
    function screen_weather_refreshTiles()
    {
        
    }
    
    function screen_weather_loadData()
    {
        // get and sanitize the weather feed URL
        var weatherFeedURL = 
            ("{{settings.screen_weather_screen_weather.weather_feed_URL}}&par={{settings.screen_weather_screen_weather.weather_feed_par_key_URL}}&key={{settings.screen_weather_screen_weather.weather_feed_main_key_URL}}")
            .replace( /&amp\;/g, "&" );
        
        // get the feed
        $.post('/proxy/',
            {'url':weatherFeedURL },
            function( weather_feed ){
            
            // load weather unit data (note: find will not find "head")
            screen_weather_units.temp = $( weather_feed ).find("ut").text();
            screen_weather_units.distance = $( weather_feed ).find("ud").text();
            screen_weather_units.speed = $( weather_feed ).find("us").text();
            screen_weather_units.pressure = $( weather_feed ).find("up").text();

            // load location data
            screen_weather_locationInfo.name = 
                $( weather_feed ).find("loc>dnam").text();
            screen_weather_locationInfo.time = 
                $( weather_feed ).find("loc>tm").text();
            screen_weather_locationInfo.sunrise = 
                $( weather_feed ).find("loc>sunr").text();
            screen_weather_locationInfo.sunset = 
                $( weather_feed ).find("loc>suns").text();

            // load current condition data
            screen_weather_cc.lastUpdate = 
                $(weather_feed).find("cc>lsup").text();
            screen_weather_cc.temp = $(weather_feed).find("cc>tmp").text();
            screen_weather_cc.feelsLike = 
                $(weather_feed).find("cc>flik").text();
            screen_weather_cc.condition = $(weather_feed).find("cc>t").text();
            screen_weather_cc.icon = $(weather_feed).find("cc>icon").text();
            screen_weather_cc.pressure.value = 
                $(weather_feed).find("cc>bar>r").text();
            screen_weather_cc.pressure.description = 
                $(weather_feed).find("cc>bar>d").text();
            screen_weather_cc.wind.speed = 
                $(weather_feed).find("cc>wind>s").text();
            screen_weather_cc.wind.from = 
                $(weather_feed).find("cc>wind>t").text();
            screen_weather_cc.humidity = $(weather_feed).find("cc>hmid").text();
            screen_weather_cc.visual = $(weather_feed).find("cc>vis").text();
            screen_weather_cc.dewpoint = $(weather_feed).find("cc>dewp").text();
            screen_weather_cc.moon.icon = 
                $(weather_feed).find("cc>moon>icon").text();
            screen_weather_cc.moon.description = 
                $(weather_feed).find("cc>moon>t").text();
            
            // load 5-day forecast data
            screen_weather_forecast.lastUpdate = 
                $(weather_feed).find("dayf>lsup").text();
            
            $(weather_feed).find("dayf>day").each(function(dayIndex){
                
                // grab the day part of the day
                var dayPart = null;
                $(this).find("part").each(function(){
                    if($(this).attr("p")=="d") dayPart = $(this);
                });
                
                // push a new day onto the days array
                screen_weather_forecast.days.push( 
                    new screen_weather_forecast_day(
                        $(this).find("hi").text(),
                        $(this).find("low").text(),
                        $(this).find("sunr").text(),
                        $(this).find("suns").text(),
                        dayPart.find("icon").text(),
                        dayPart.find("t").text(),
                        dayPart.find("wind>s").text(),
                        dayPart.find("wind>t").text(),
                        dayPart.find("ppcp").text(),
                        dayPart.find("hmid").text()
                    )
                );
            });
            
            alert( screen_weather_forecast.days[4].humidity );
        });
    }
    
</script>

<!-- Current Weather Tile -->
<div id="screen_weather_current" class="display_tile display_content">
    <h1>Current Weather Placeholder</h1>
</div>

<!-- Maps Tile -->
<div id="screen_weather_maps" class="display_tile display_content">
    <h1>Maps Placeholder</h1>
</div>

<!-- 5-Day Forecast Tile -->
<div id="screen_weather_forecast" 
    class="display_tile display_content">
    
    <h1>5-Day Forecast Placeholder</h1>
</div>
